# OpCore Development Guide

## Registration & Profile Architecture

### 1. Data Flow
The registration process follows a strict "Offline-First" but "Cloud-Synced" architecture.

1.  **Frontend (`/register`):** Collects data -> Validates input logic (e.g., Password strength).
2.  **API (`POST /api/auth/register`):**
    -   Receives DTO (Data Transfer Object).
    -   Calls `@opcore/auth` service.
    -   **Prisma:** Creates `User` record with all compliance fields.
    -   **Cookies:** Sets `access_token` and `refresh_token` HTTP-only cookies.
3.  **Client State (Post-Registration):**
    -   The `OnboardingScreen` (or `RegisterPage`) redirects to `/dashboard`.
    -   The `UserContext` or WatermelonDB sync pulls the new user profile locally.

### 2. File Structure
-   **Auth Pages:** `apps/web/src/app/(auth)/`
-   **API Routes:** `apps/web/src/app/api/auth/`
-   **Business Logic:** `packages/auth/src/` (Session & Registration logic)
-   **Database Schema:** `packages/db/prisma/schema.prisma`

### 3. Adding New Fields
To add a new field to the user profile (e.g., `websiteUrl`):
1.  **Schema:** Add field to `User` model in `schema.prisma`. Run `db push`.
2.  **Frontend:** Add input to `Brand Studio` form.
3.  **Action:** Update `updateUser` server action or API route to accept the field.
4.  **Type Safety:** Ensure the TypeScript interface for `User` is updated (usually auto-generated by Prisma).

### 4. Smart Logic Implementation
-   **VAT Exemption:** Logic resides in `packages/tax-engine` (or util functions) but data is stored in `User.isVatExempt`.
-   **Trigger:** When `turnoverBand` changes in Brand Studio, re-evaluate `isVatExempt` status immediately.
